rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner of a trip
    function isOwner(tripData) {
      return isAuthenticated() && request.auth.uid == tripData.ownerId;
    }
    
    // Helper function to check if user is a member of a trip
    function isMember(tripData) {
      return isAuthenticated() && request.auth.uid in tripData.members;
    }
    
    // Helper function to check if trip is public
    function isPublic(tripData) {
      return tripData.isPublic == true;
    }
    
    // Rules for trips collection
    match /trips/{tripId} {
      // Allow read if:
      // - Trip is public, OR
      // - User is the owner, OR
      // - User is a member
      allow read: if isPublic(resource.data) 
                  || isOwner(resource.data) 
                  || isMember(resource.data);
      
      // Allow create if:
      // - User is authenticated AND
      // - User is setting themselves as the owner
      allow create: if isAuthenticated() 
                    && request.resource.data.ownerId == request.auth.uid
                    && request.auth.uid in request.resource.data.members;
      
      // Allow update if:
      // - User is the owner
      allow update: if isOwner(resource.data);
      
      // Allow delete if:
      // - User is the owner
      allow delete: if isOwner(resource.data);
      
      // Rules for itinerary subcollection
      match /itinerary/{dayId} {
        // Allow read if parent trip is readable
        allow read: if isPublic(get(/databases/$(database)/documents/trips/$(tripId)).data)
                    || isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data)
                    || isMember(get(/databases/$(database)/documents/trips/$(tripId)).data);
        
        // Allow write if user is owner or member of parent trip
        allow write: if isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data)
                     || isMember(get(/databases/$(database)/documents/trips/$(tripId)).data);
      }
      
      // Rules for expenses subcollection
      match /expenses/{expenseId} {
        // Allow read if parent trip is readable
        allow read: if isPublic(get(/databases/$(database)/documents/trips/$(tripId)).data)
                    || isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data)
                    || isMember(get(/databases/$(database)/documents/trips/$(tripId)).data);
        
        // Allow write if user is owner or member of parent trip
        allow write: if isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data)
                     || isMember(get(/databases/$(database)/documents/trips/$(tripId)).data);
      }
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
